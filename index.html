<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Administrador - Folha de Ponto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 500px; }
        main { flex-grow: 1; }
    </style>
</head>
<body class="bg-gray-100">

    <main>
        <div id="login-section" class="container mx-auto p-8 flex items-center justify-center min-h-full">
            <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
                <h2 class="text-xl font-bold mb-4 text-center">Acesso ao Painel</h2>
                <form id="admin-login-form" class="space-y-4"><input id="admin-email-input" type="email" required class="w-full px-3 py-2 border rounded-md" placeholder="E-mail do Administrador"><input id="admin-password" type="password" required class="w-full px-3 py-2 border rounded-md" placeholder="Senha"><button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Entrar</button></form>
                <p id="auth-error" class="mt-4 text-sm text-red-600 text-center"></p>
            </div>
        </div>

        <div id="admin-panel" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="flex flex-wrap justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">Painel de Registos</h1>
                <div><span id="admin-email" class="text-sm text-gray-600 mr-4"></span><button id="logout-button" class="px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-100 rounded-md hover:bg-indigo-200">Sair</button></div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-lg font-medium text-gray-700 mb-4">Resumo Geral do Período</h2>
                <div id="general-summary" class="space-y-4"><p class="text-gray-500 text-center">Nenhum saldo para exibir.</p></div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-medium text-gray-900">Filtros e Ações</h2>
                    <button id="add-record-button" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Adicionar Registo</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div><label for="user-filter" class="block text-sm font-medium">Funcionário</label><select id="user-filter" class="mt-1 block w-full py-2 px-3 border rounded-md"><option value="all">Todos</option></select></div>
                    <div><label for="month-filter" class="block text-sm font-medium">Mês</label><select id="month-filter" class="mt-1 block w-full py-2 px-3 border rounded-md"><option value="all">Todos</option><option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option></select></div>
                    <div><label for="year-filter" class="block text-sm font-medium">Ano</label><input type="number" id="year-filter" placeholder="Ex: 2025" class="mt-1 block w-full py-2 px-3 border rounded-md"></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">Funcionário</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">Entradas</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Saídas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase">Saldo</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                    <p id="loading-message" class="text-center py-8 text-gray-500">A carregar...</p>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="w-full bg-white p-6 mt-10 shadow-inner">
        <div class="text-center text-sm text-gray-600">
            <p class="font-bold">Defensoria Pública do Estado do Rio de Janeiro</p>
            <p>Sede Administrativa - Coordenação de Gestão Documental</p>
            <p>Email: codoc@defensoria.rj.def.br</p>
            <p>Avenida Marechal Câmara, 314 - CEP 20020-080 - Centro, RJ</p>
            <p class="mt-2 text-xs text-gray-500">Desenvolvido por Alex do Vale</p>
        </div>
    </footer>
    
    <!-- Modals -->
    <div id="edit-modal" class="modal"><div class="modal-content"><h3 id="modal-title" class="text-lg font-bold mb-4">Editar Registos</h3><div><label class="font-medium">Realocar para Data:</label><input type="date" id="edit-date-input" class="w-full mt-1 px-3 py-2 border rounded-md"></div><div id="edit-fields-container" class="space-y-2 mt-4"></div><div class="mt-6 flex justify-end gap-4"><button id="cancel-edit-button" class="px-4 py-2 rounded-md bg-gray-200">Cancelar</button><button id="save-edit-button" class="px-4 py-2 rounded-md text-white bg-indigo-600">Salvar</button></div><p id="modal-error" class="text-sm text-red-600 mt-2"></p></div></div>
    <div id="request-view-modal" class="modal"><div class="modal-content"><h3 id="request-view-title" class="text-lg font-bold mb-4">Ver Solicitação</h3><div class="p-4 bg-gray-100 rounded-md mb-4"><p id="request-view-text" class="text-gray-800 whitespace-pre-wrap"></p></div><div class="mt-6 flex justify-end gap-4"><button id="decline-request-button" class="px-4 py-2 rounded-md text-white bg-red-600">Recusar</button><button id="approve-request-button" class="px-4 py-2 rounded-md text-white bg-green-600">Aprovar</button><button id="close-request-view-button" class="px-4 py-2 rounded-md bg-gray-200">Fechar</button></div></div></div>
    <div id="add-record-modal" class="modal"><div class="modal-content"><h3 class="text-lg font-bold mb-4">Adicionar Novo Registo</h3><form id="add-record-form" class="space-y-4"><div><label for="add-record-user" class="block text-sm font-medium">Funcionário</label><select id="add-record-user" required class="mt-1 w-full py-2 px-3 border rounded-md"></select></div><div><label for="add-record-date" class="block text-sm font-medium">Data</label><input type="date" id="add-record-date" required class="mt-1 w-full py-2 px-3 border rounded-md"></div><div><label for="add-record-time" class="block text-sm font-medium">Hora</label><input type="time" id="add-record-time" required class="mt-1 w-full py-2 px-3 border rounded-md"></div><div><label for="add-record-type" class="block text-sm font-medium">Tipo</label><select id="add-record-type" required class="mt-1 w-full py-2 px-3 border rounded-md"><option value="in">Entrada</option><option value="out">Saída</option></select></div><div class="mt-6 flex justify-end gap-4"><button type="button" id="cancel-add-button" class="px-4 py-2 rounded-md bg-gray-200">Cancelar</button><button type="submit" class="px-4 py-2 rounded-md text-white bg-indigo-600">Adicionar</button></div></form><p id="add-record-error" class="text-sm text-red-600 mt-2"></p></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, collectionGroup, setLogLevel, doc, writeBatch, Timestamp, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyBqWlyh2vo0I_gRWysG2NYdz0gvopRO3SI", authDomain: "sistema-ponto-v2.firebaseapp.com", projectId: "sistema-ponto-v2", storageBucket: "sistema-ponto-v2.firebasestorage.app", messagingSenderId: "582643132528", appId: "1:582643132528:web:2d489ae3c23786152a2cb5" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const ui = {
            loginSection: document.getElementById('login-section'), adminPanel: document.getElementById('admin-panel'), adminLoginForm: document.getElementById('admin-login-form'), authError: document.getElementById('auth-error'), logoutButton: document.getElementById('logout-button'), adminEmailSpan: document.getElementById('admin-email'),
            summary: document.getElementById('general-summary'), userFilter: document.getElementById('user-filter'), monthFilter: document.getElementById('month-filter'), yearFilter: document.getElementById('year-filter'), tableBody: document.getElementById('records-table-body'), loading: document.getElementById('loading-message'), addRecordBtn: document.getElementById('add-record-button'),
            edit: { modal: document.getElementById('edit-modal'), title: document.getElementById('modal-title'), dateInput: document.getElementById('edit-date-input'), fields: document.getElementById('edit-fields-container'), cancel: document.getElementById('cancel-edit-button'), save: document.getElementById('save-edit-button'), error: document.getElementById('modal-error') },
            request: { modal: document.getElementById('request-view-modal'), title: document.getElementById('request-view-title'), text: document.getElementById('request-view-text'), approve: document.getElementById('approve-request-button'), decline: document.getElementById('decline-request-button'), close: document.getElementById('close-request-view-button') },
            add: { modal: document.getElementById('add-record-modal'), form: document.getElementById('add-record-form'), cancel: document.getElementById('cancel-add-button'), error: document.getElementById('add-record-error'), userSelect: document.getElementById('add-record-user') }
        };

        let allRecords = [], usersMap = {}, allRequests = [], currentDayEntries = [], currentRequest = null;
        
        onAuthStateChanged(auth, async (user) => { 
            const isLoggedIn = !!user;
            ui.loginSection.classList.toggle('hidden', isLoggedIn); 
            ui.adminPanel.classList.toggle('hidden', !isLoggedIn); 
            if (isLoggedIn) { 
                ui.adminEmailSpan.textContent = user.email; 
                ui.yearFilter.value = new Date().getFullYear(); 
                await loadAllData(); 
            }
        });
        
        async function loadAllData() {
            ui.loading.textContent = "A carregar dados...";
            try {
                const [usersSnap, recordsSnap, requestsSnap] = await Promise.all([
                    getDocs(collection(db, "users")),
                    getDocs(query(collectionGroup(db, 'time_entries'))),
                    getDocs(collection(db, `/artifacts/${appId}/requests`))
                ]);
                usersMap = {};
                usersSnap.forEach(doc => usersMap[doc.id] = doc.data().name || 'Nome não encontrado');
                allRecords = recordsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allRequests = requestsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateUserFilter();
                renderTable();
            } catch (e) {
                ui.loading.textContent = "Erro ao carregar dados. Verifique as regras de segurança.";
            }
        }
        
        function renderTable() {
            const filteredRecords = allRecords.filter(r => {
                const d = r.timestamp.toDate();
                return (ui.userFilter.value === 'all' || r.userId === ui.userFilter.value) && (ui.monthFilter.value === 'all' || (d.getMonth() + 1) == ui.monthFilter.value) && (!ui.yearFilter.value || d.getFullYear() == ui.yearFilter.value);
            });
            const recordsByDay = filteredRecords.reduce((acc, r) => { (acc[`${r.userId}-${r.timestamp.toDate().toISOString().split('T')[0]}`] ||= []).push(r); return acc; }, {});
            
            ui.tableBody.innerHTML = '';
            ui.loading.classList.toggle('hidden', Object.keys(recordsByDay).length > 0);
            if(Object.keys(recordsByDay).length === 0) { ui.loading.textContent = "Nenhum registo encontrado."; renderSummary({}); return; }

            const monthlyBalances = {};
            Object.keys(recordsByDay).sort().reverse().forEach(key => {
                const dayEntries = recordsByDay[key].sort((a,b) => a.timestamp.toMillis() - b.timestamp.toMillis());
                const { userId } = dayEntries[0];
                const date = dayEntries[0].timestamp.toDate();
                const dateStr = date.toLocaleDateString('pt-BR');
                let workedMs = 0;
                for (let i=0; i < dayEntries.length - 1; i+=2) if(dayEntries[i].type==='in'&&dayEntries[i+1].type==='out') workedMs += dayEntries[i+1].timestamp.toMillis() - dayEntries[i].timestamp.toMillis();
                
                let balanceText = '---', balanceClass = 'text-gray-700';
                if (dayEntries.length % 2 === 0 && dayEntries.length > 0) {
                    const balanceMs = workedMs - (6*3600*1000);
                    balanceText = formatMilliseconds(balanceMs, true);
                    balanceClass = balanceMs >= 0 ? 'text-green-600' : 'text-red-600';
                    const monthKey = `${date.getMonth()+1}/${date.getFullYear()}`;
                    (monthlyBalances[monthKey] ||= {})[userId] ||= { name: usersMap[userId] || userId, balanceMs: 0 };
                    monthlyBalances[monthKey][userId].balanceMs += balanceMs;
                }
                
                const request = allRequests.find(r => r.userId === userId && r.date === dateStr);
                let requestIcon = '';
                if (request) {
                    const color = { pending: 'text-yellow-500', approved: 'text-green-500', declined: 'text-red-500' }[request.status];
                    requestIcon = `<button class="request-view-btn"><svg class="w-6 h-6 ${color}" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/></svg></button>`;
                }

                const row = ui.tableBody.insertRow();
                row.innerHTML = `<td class="px-6 py-4">${usersMap[userId]}</td><td class="px-6 py-4">${dateStr}</td><td class="px-6 py-4">${dayEntries.filter(e=>e.type==='in').map(e=>e.timestamp.toDate().toLocaleTimeString('pt-BR')).join(', ')}</td><td class="px-6 py-4">${dayEntries.filter(e=>e.type==='out').map(e=>e.timestamp.toDate().toLocaleTimeString('pt-BR')).join(', ')}</td><td class="px-6 py-4 font-medium ${balanceClass}">${balanceText}</td><td class="px-6 py-4"><button class="edit-btn text-indigo-600 hover:text-indigo-900">Editar</button> ${requestIcon}</td>`;
                row.querySelector('.edit-btn').addEventListener('click', () => openEditModal(dayEntries));
                if(request) row.querySelector('.request-view-btn').addEventListener('click', () => openRequestViewModal(request));
            });
            renderSummary(monthlyBalances);
        }

        function renderSummary(balances) {
            ui.summary.innerHTML = '';
            const sortedMonths = Object.keys(balances).sort((a,b) => new Date(b.split('/')[1], b.split('/')[0]-1) - new Date(a.split('/')[1], a.split('/')[0]-1));
            if(sortedMonths.length === 0) { ui.summary.innerHTML = '<p class="text-gray-500 text-center">Nenhum saldo para exibir.</p>'; return; }
            sortedMonths.forEach(monthKey => {
                const [m, y] = monthKey.split('/');
                const monthName = new Date(y, m-1).toLocaleString('pt-BR', {month:'long'});
                ui.summary.innerHTML += `<h3 class="text-md font-semibold mt-4 first:mt-0">${monthName.charAt(0).toUpperCase()+monthName.slice(1)} de ${y}</h3>`;
                const userBalances = balances[monthKey];
                Object.keys(userBalances).sort((a,b) => userBalances[a].name.localeCompare(userBalances[b].name)).forEach(userId => {
                    const u = userBalances[userId];
                    const balanceText = formatMilliseconds(u.balanceMs, true);
                    const balanceClass = u.balanceMs >= 0 ? 'text-green-600' : 'text-red-600';
                    ui.summary.innerHTML += `<div class="flex justify-between py-2 border-b"><span class="font-medium">${u.name}</span><span class="font-bold text-lg ${balanceClass}">${balanceText}</span></div>`;
                });
            });
        }
        
        function openEditModal(dayEntries) {
            currentDayEntries = dayEntries;
            const originalDate = dayEntries[0].timestamp.toDate();
            ui.edit.error.textContent = '';
            ui.edit.title.textContent = `Editar Registos de ${usersMap[dayEntries[0].userId]}`;
            ui.edit.dateInput.value = originalDate.toISOString().split('T')[0];
            ui.edit.fields.innerHTML = dayEntries.map((entry, i) => `
                <div class="grid grid-cols-4 items-center gap-2">
                    <label class="font-medium">${entry.type === 'in' ? 'Entrada' : 'Saída'} ${Math.floor(i / 2) + 1}</label>
                    <input type="time" step="1" value="${entry.timestamp.toDate().toTimeString().slice(0, 8)}" data-entry-id="${entry.id}" class="col-span-2 w-full px-3 py-2 border rounded-md">
                    <button class="delete-entry-btn text-red-500 hover:text-red-700 justify-self-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>`).join('');
            
            ui.edit.fields.querySelectorAll('.delete-entry-btn').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const row = btn.parentElement;
                    const isMarked = row.dataset.markedForDeletion === 'true';
                    row.dataset.markedForDeletion = String(!isMarked);
                    row.classList.toggle('opacity-50', !isMarked);
                    row.querySelector('input').disabled = !isMarked;
                });
            });
            ui.edit.modal.style.display = 'flex';
        }

        function openRequestViewModal(request) {
            currentRequest = request;
            ui.request.title.textContent = `Solicitação de ${request.userName} - ${request.date}`;
            ui.request.text.textContent = request.text;
            const isPending = request.status === 'pending';
            ui.request.approve.classList.toggle('hidden', !isPending);
            ui.request.decline.classList.toggle('hidden', !isPending);
            ui.request.modal.style.display = 'flex';
        }
        
        async function saveTimeChanges() {
            const batch = writeBatch(db);
            const newDateStr = ui.edit.dateInput.value;

            for (const row of ui.edit.fields.children) {
                const input = row.querySelector('input');
                const entryId = input.dataset.entryId;
                const originalEntry = currentDayEntries.find(e => e.id === entryId);
                const docRef = doc(db, `/artifacts/${appId}/users/${originalEntry.userId}/time_entries/${entryId}`);
                
                if (row.dataset.markedForDeletion === 'true') {
                    batch.delete(docRef);
                    continue;
                }

                const [h, m, s] = input.value.split(':');
                const [y, M, d] = newDateStr.split('-');
                const newTimestamp = Timestamp.fromDate(new Date(y, M - 1, d, h, m, s || 0));
                
                if (newTimestamp.toMillis() !== originalEntry.timestamp.toMillis()) {
                    batch.update(docRef, { timestamp: newTimestamp });
                }
            }

            try { await batch.commit(); ui.edit.modal.style.display = 'none'; await loadAllData(); } catch (error) { ui.edit.error.textContent = "Falha ao salvar."; }
        }

        async function handleAddRecord(e) {
            e.preventDefault();
            const { userSelect, date, time, type } = ui.add.form.elements;
            if (!userSelect.value || !date.value || !time.value) { ui.add.error.textContent = 'Todos os campos são obrigatórios.'; return; }
            const [y, M, d] = date.value.split('-');
            const [h, m] = time.value.split(':');
            const newTimestamp = Timestamp.fromDate(new Date(y, M - 1, d, h, m));
            try { await addDoc(collection(db, `/artifacts/${appId}/users/${userSelect.value}/time_entries`), { type: type.value, timestamp: newTimestamp, userId: userSelect.value }); ui.add.modal.style.display = 'none'; await loadAllData(); } catch (error) { ui.add.error.textContent = "Falha ao adicionar registo."; }
        }
        
        async function handleRequest(status) {
            if (!currentRequest) return;
            const docRef = doc(db, `/artifacts/${appId}/requests/${currentRequest.id}`);
            try { await updateDoc(docRef, { status }); ui.request.modal.style.display = 'none'; await loadAllData(); } catch (error) { alert('Falha ao atualizar a solicitação.'); }
        }

        ui.adminLoginForm.addEventListener('submit', async (e) => { e.preventDefault(); ui.authError.textContent = ''; try { await setPersistence(auth, browserSessionPersistence); await signInWithEmailAndPassword(auth, ui.adminLoginForm.email.value, ui.adminLoginForm.password.value); } catch (error) { ui.authError.textContent = "E-mail ou senha inválidos."; }});
        ui.logoutButton.addEventListener('click', () => signOut(auth));
        [ui.userFilter, ui.monthFilter, ui.yearFilter].forEach(el => el.addEventListener('change', renderTable));
        ui.edit.cancel.addEventListener('click', () => ui.edit.modal.style.display = 'none');
        ui.edit.save.addEventListener('click', saveTimeChanges);
        ui.request.close.addEventListener('click', () => ui.request.modal.style.display = 'none');
        ui.request.approve.addEventListener('click', () => handleRequest('approved'));
        ui.request.decline.addEventListener('click', () => handleRequest('declined'));
        ui.addRecordBtn.addEventListener('click', openAddRecordModal);
        ui.add.cancel.addEventListener('click', () => ui.add.modal.style.display = 'none');
        ui.add.form.addEventListener('submit', handleAddRecord);
        
        function populateUserFilter() { ui.userFilter.innerHTML = '<option value="all">Todos</option>'; Object.keys(usersMap).sort((a,b) => usersMap[a].localeCompare(usersMap[b])).forEach(uid => { const o = document.createElement('option'); o.value = uid; o.textContent = usersMap[uid]; ui.userFilter.appendChild(o); }); }
        function formatMilliseconds(ms, neg = false) { const s = ms < 0 ? '-' : ''; if(neg) ms=Math.abs(ms); else if(ms<0)ms=0; const t=Math.floor(ms/1000), h=Math.floor(t/3600), m=Math.floor((t%3600)/60); return `${s}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
    </script>
</body>
</html>

