<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - Ponto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 500px; }
        main { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10B981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .editable { cursor: pointer; }
        .editable:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100">

    <main class="py-12 px-4">
        <div id="login-screen" class="w-full max-w-md">
            <div class="bg-white p-8 rounded-lg shadow-md space-y-6">
                <div class="flex flex-col items-center">
                    <img src="https://raw.githubusercontent.com/alexdovale/calculo-mensuracao-codoc/main/logo.png" alt="Logotipo da Empresa" class="mb-4 h-12">
                    <h2 class="text-center text-xl font-bold text-gray-700">COORDENAÇÃO DE GESTÃO DOCUMENTAL</h2>
                    <p class="mt-2 text-center text-2xl font-extrabold text-gray-900">Painel do Administrador</p>
                </div>
                <form id="login-form" class="space-y-6" onsubmit="return false;">
                    <div><input id="email" type="email" autocomplete="email" required class="w-full px-3 py-2 border rounded-md focus:ring-green-500 focus:border-green-500" placeholder="Seu e-mail"></div>
                    <div><input id="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 border rounded-md focus:ring-green-500 focus:border-green-500" placeholder="Sua senha"></div>
                    <p id="login-error" class="text-sm text-red-600"></p>
                    <div><button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700">Entrar</button></div>
                    <div class="text-sm text-center"><a href="#" id="forgot-password-link" class="font-medium text-green-600 hover:text-green-500">Esqueceu sua senha?</a></div>
                </form>
            </div>
        </div>

        <div id="app-screen" class="hidden w-full max-w-6xl">
            <div class="bg-white p-4 sm:p-8 rounded-lg shadow-md space-y-6">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <img src="https://raw.githubusercontent.com/alexdovale/calculo-mensuracao-codoc/main/logo.png" alt="Logotipo da Empresa" class="h-10">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Olá, <span id="user-name"></span>!</h1>
                            <p id="header-date" class="text-gray-600"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <div id="requests-notification-icon" class="relative p-2 rounded-full hover:bg-gray-100 cursor-pointer" title="Ver Solicitações Pendentes">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                                </svg>
                                <span id="requests-notification-badge" class="hidden absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-600 rounded-full"></span>
                            </div>

                            <div id="requests-notification-popover" class="hidden absolute top-full right-0 mt-2 w-72 bg-white border border-gray-200 rounded-md shadow-lg z-50">
                                <div class="p-3 border-b border-gray-200">
                                    <h4 class="font-semibold text-gray-800">Solicitações Pendentes</h4>
                                </div>
                                <ul id="requests-notification-list" class="max-h-64 overflow-y-auto divide-y divide-gray-100">
                                    <li class="p-3 text-sm text-gray-500">Nenhuma solicitação pendente.</li>
                                </ul>
                            </div>
                        </div>
                        <button id="logout-button" class="px-4 py-2 text-sm font-medium text-green-600 bg-green-100 rounded-md hover:bg-green-200">Sair</button>
                    </div>
                    </div>

                <div class="space-y-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="tab-reports" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-green-500 text-green-600">
                                Relatórios de Ponto
                            </button>
                            <button id="tab-requests" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Solicitações
                            </button>
                            <button id="tab-users" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Gerenciamento
                            </button>
                        </nav>
                    </div>
                    <div id="tab-panel-reports" class="tab-panel space-y-6">
                        <div>
                            <h2 class="text-xl font-bold mb-4">Relatórios de Ponto</h2>
                            <select id="user-dropdown" class="w-full p-2 border rounded-md mb-4"></select>
                            
                            <div class="flex flex-wrap gap-4 items-end bg-gray-50 p-4 rounded-lg mb-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Data Inicial:</label>
                                    <input type="date" id="report-start-date" class="p-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Data Final:</label>
                                    <input type="date" id="report-end-date" class="p-2 border rounded-md">
                                </div>
                                <button id="generate-report-btn" class="py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700 h-10">Gerar Relatório</button>
                                <button id="download-pdf-btn" class="py-2 px-4 rounded-md text-white bg-blue-600 hover:bg-blue-700 h-10 hidden">Baixar PDF</button>
                            </div>
                        </div>

                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h3 class="text-lg font-medium mb-4">Lançamento Rápido de Período</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label for="quick-entry-start-date" class="block text-sm font-medium text-gray-700">Data de Início:</label>
                                    <input type="date" id="quick-entry-start-date" class="mt-1 p-2 border rounded-md w-full">
                                </div>
                                <div>
                                    <label for="quick-entry-end-date" class="block text-sm font-medium text-gray-700">Data de Fim:</label>
                                    <input type="date" id="quick-entry-end-date" class="mt-1 p-2 border rounded-md w-full">
                                </div>
                                <div>
                                    <label for="quick-entry-type" class="block text-sm font-medium text-gray-700">Tipo:</label>
                                    <select id="quick-entry-type" class="mt-1 p-2 border rounded-md w-full">
                                        <option value="Férias">Férias</option>
                                        <option value="Licença Médica">Licença Médica</option>
                                        <option value="Licença Maternidade/Paternidade">Licença Maternidade/Paternidade</option>
                                        <option value="Outra Licença">Outra Licença</option>
                                    </select>
                                </div>
                                <button id="apply-quick-entry-btn" class="py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 h-10">Aplicar</button>
                            </div>
                            <p id="quick-entry-status" class="text-sm mt-4 text-center"></p>
                        </div>
                        
                        <div id="reports-container">
                            <h3 id="report-title" class="text-lg font-medium">Histórico de Registros</h3>
                            <div class="mt-4 overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead id="report-table-head" class="bg-gray-50"></thead>
                                    <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                                <div id="monthly-balance" class="mt-4 p-4 bg-gray-100 rounded-md font-bold text-center hidden"></div>
                                <div id="occurrence-section" class="mt-4 hidden">
                                    <label for="occurrence-details" class="block text-sm font-medium text-gray-700 mb-1">Registro de Ocorrência (vinculado ao mês da data inicial):</label>
                                    <textarea id="occurrence-details" rows="3" class="w-full p-2 border rounded-md" placeholder="Digite aqui qualquer ocorrência para incluir no relatório..."></textarea>
                                    <div class="flex justify-end items-center mt-2">
                                        <span id="occurrence-status" class="text-sm text-gray-500 mr-4"></span>
                                        <button id="save-occurrence-btn" class="py-1 px-3 rounded-md text-sm text-white bg-indigo-600 hover:bg-indigo-700">Salvar Ocorrência</button>
                                    </div>
                                </div>
                                <p id="no-report-message" class="text-center py-4 text-gray-500">Selecione um funcionário para ver o relatório.</p>
                            </div>
                        </div>
                    </div>

                    <div id="tab-panel-requests" class="tab-panel hidden">
                        <div>
                            <h3 class="text-lg font-medium">Solicitações de Funcionários</h3>
                            <div class="my-4 flex flex-wrap gap-4 items-center p-4 bg-gray-50 rounded-lg">
                                <select id="request-user-filter" class="p-2 border rounded-md flex-grow sm:flex-grow-0"></select>
                                <input type="date" id="request-start-date-filter" class="p-2 border rounded-md flex-grow sm:flex-grow-0">
                                <input type="date" id="request-end-date-filter" class="p-2 border rounded-md flex-grow sm:flex-grow-0">
                                <input type="text" id="request-search-filter" class="p-2 border rounded-md flex-grow" placeholder="Pesquisar por texto...">
                            </div>
                            <div class="mt-4 overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Funcionário</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mensagem</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="request-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="tab-panel-users" class="tab-panel hidden">
                        <div>
                            <h3 class="text-lg font-medium">Gerenciamento de Usuários</h3>
                            <div class="my-4 flex flex-wrap gap-4 items-center p-4 bg-gray-50 rounded-lg">
                                <input type="text" id="user-search-filter" class="p-2 border rounded-md flex-grow" placeholder="Pesquisar por nome...">
                                <select id="user-status-filter" class="p-2 border rounded-md">
                                    <option value="all">Todos os Status</option>
                                    <option value="active" selected>Ativos</option>
                                    <option value="inactive">Inativos</option>
                                </select>
                            </div>
                            <div class="mt-4 overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-management-table-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    </div>
            </div>
        </div>
    </main>

    <footer class="w-full bg-white p-6 shadow-inner">
        <div class="text-center text-sm text-gray-600">
            <p class="font-bold">Defensoria Pública do Estado do Rio de Janeiro</p>
            <p>Sede Administrativa - Coordenação de Gestão Documental</p>
            <p>Email: codoc@defensoria.rj.def.br</p>
            <p>Avenida Marechal Câmara, 314 - CEP 20020-080 - Centro, RJ</p>
            <p class="mt-2 text-xs text-gray-500">Desenvolvido por Alex do Vale</p>
        </div>
    </footer>
    
    <div id="forgot-password-modal" class="modal"><div class="modal-content"><span id="close-forgot-modal-button" class="float-right text-2xl font-bold cursor-pointer">&times;</span><h3 class="text-lg font-medium mb-4">Redefinir Senha</h3><p class="text-sm text-gray-600 mb-4">Digite seu e-mail para receber um link de redefinição.</p><form id="forgot-password-form"><input id="forgot-email" type="email" required placeholder="Seu e-mail" class="w-full px-3 py-2 border rounded-md"><button type="submit" class="mt-4 w-full py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700">Enviar Link</button></form><p id="modal-message" class="text-sm mt-4 text-center"></p></div></div>
    <div id="delete-confirm-modal" class="modal"><div class="modal-content"><h3 id="delete-modal-title" class="text-lg font-medium mb-4">Confirmar Exclusão</h3><p id="delete-modal-text" class="text-sm text-gray-600 mb-4"></p><div class="flex justify-end gap-4"><button id="cancel-delete-btn" class="py-2 px-4 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button><button id="confirm-delete-btn" class="py-2 px-4 rounded-md text-white bg-red-600 hover:bg-red-700">Apagar</button></div></div></div>
    <div id="edit-modal" class="modal"><div class="modal-content"><h3 class="text-lg font-medium mb-4">Editar Registro de Ponto</h3><div class="mb-4"><label for="edit-time-input" class="block text-sm font-medium text-gray-700 mb-1">Horário:</label><input type="time" id="edit-time-input" class="w-full px-3 py-2 border rounded-md"></div><div class="flex justify-end gap-4"><button id="cancel-edit-btn" class="py-2 px-4 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button><button id="save-edit-btn" class="py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700">Salvar</button></div></div></div>
    <div id="add-entry-modal" class="modal"><div class="modal-content"><h3 class="text-lg font-medium mb-4">Adicionar/Editar Batidas do Dia</h3><p id="add-entry-date" class="text-sm font-bold mb-4 text-gray-700"></p><div class="grid grid-cols-2 gap-4"><div><label for="add-entry-in-1" class="block text-sm font-medium text-gray-700 mb-1">Entrada:</label><input type="time" id="add-entry-in-1" class="w-full px-3 py-2 border rounded-md"></div><div><label for="add-entry-out-1" class="block text-sm font-medium text-gray-700 mb-1">Saída:</label><input type="time" id="add-entry-out-1" class="w-full px-3 py-2 border rounded-md"></div></div><p id="add-entry-message" class="text-sm mt-4 text-center"></p><div class="flex justify-end gap-4 mt-6"><button id="cancel-add-btn" class="py-2 px-4 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button><button id="save-add-btn" class="py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700">Salvar</button></div></div></div>
    <div id="justify-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-medium mb-4">Justificar/Abonar Dia</h3>
            <p id="justify-date" class="text-sm font-bold mb-4 text-gray-700"></p>
            <div class="space-y-4">
                <div>
                    <label for="justify-reason" class="block text-sm font-medium text-gray-700 mb-1">Motivo / Descrição:</label>
                    <input type="text" id="justify-reason" class="w-full px-3 py-2 border rounded-md" placeholder="Ex: Feriado, Atestado Médico, Banco de Horas...">
                </div>
                <div>
                    <label for="justify-hours" class="block text-sm font-medium text-gray-700 mb-1">Horas a Abonar (opcional):</label>
                    <input type="time" id="justify-hours" class="w-full px-3 py-2 border rounded-md">
                    <p class="text-xs text-gray-500 mt-1">Deixe em branco para justificar o dia todo sem batidas (ex: Férias). Para abono parcial com batidas, insira o tempo a creditar.</p>
                </div>
            </div>
            <p id="justify-message" class="text-sm mt-4 text-center"></p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-justify-btn" class="py-2 px-4 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button>
                <button id="save-justify-btn" class="py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700">Salvar Justificativa</button>
            </div>
        </div>
    </div>
    <div id="request-action-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-medium mb-4">Analisar Solicitação</h3>
            <div class="space-y-4 text-sm">
                <p><strong>Funcionário:</strong> <span id="req-modal-user-name"></span></p>
                <p><strong>Data:</strong> <span id="req-modal-date"></span></p>
                <div>
                    <p class="font-medium text-gray-700">Justificativa do Funcionário:</p>
                    <p id="req-modal-text" class="mt-1 p-2 bg-gray-100 rounded-md"></p>
                </div>
                <div>
                    <label for="req-modal-abono" class="block font-medium text-gray-700 mb-1">Abonar Horas/Minutos:</label>
                    <input type="time" id="req-modal-abono" class="w-full px-3 py-2 border rounded-md">
                    <p class="text-xs text-gray-500 mt-1">Deixe em branco para não abonar. 06:00 para abonar o dia todo.</p>
                </div>
            </div>
            <p id="req-modal-message" class="text-sm mt-4 text-center"></p>
            <div class="flex flex-wrap justify-end gap-2 mt-6">
                <button id="cancel-req-action-btn" class="py-2 px-4 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button>
                <button id="delete-req-action-btn" class="py-2 px-4 rounded-md text-white bg-red-600 hover:bg-red-700">Apagar</button>
                <button id="decline-req-action-btn" class="py-2 px-4 rounded-md text-white bg-orange-600 hover:bg-orange-700">Recusar</button>
                <button id="approve-req-action-btn" class="py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700">Aprovar</button>
            </div>
        </div>
    </div>
    <div id="final-report-modal" class="modal">
        <div class="modal-content max-w-3xl w-full">
            <span id="close-final-report-modal" class="float-right text-2xl font-bold cursor-pointer">&times;</span>
            <h3 class="text-lg font-bold mb-4">Relatório Final de Horas</h3>
            <div id="final-report-content" class="space-y-3 text-gray-700">
                </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="download-final-pdf-btn" class="py-2 px-4 rounded-md text-white bg-blue-600 hover:bg-blue-700">Baixar PDF</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, Timestamp, updateDoc, query, orderBy, getDocs, where, deleteDoc, setDoc, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = "1:582643132528:web:2d489ae3c23786152a2cb5";
        const firebaseConfig = {
            apiKey: "AIzaSyBqWlyh2vo0I_gRWysG2NYdz0gvopRO3SI",
            authDomain: "sistema-ponto-v2.firebaseapp.com",
            projectId: "sistema-ponto-v2",
            storageBucket: "sistema-ponto-v2.appspot.com",
            messagingSenderId: "582643132528",
            appId: "1:582643132528:web:2d489ae3c23786152a2cb5",
            measurementId: "G-E1SLMCBYZV"
        };
        
        let app, auth, db;
        try { 
            app = initializeApp(firebaseConfig); 
            auth = getAuth(app); 
            db = getFirestore(app); 
        } catch (e) { 
            document.body.innerHTML = `<div class="text-red-500 p-8">Erro de configuração do Firebase.</div>`; 
        }

        const ui = {
            loginScreen: document.getElementById('login-screen'), appScreen: document.getElementById('app-screen'),
            loginForm: document.getElementById('login-form'), loginError: document.getElementById('login-error'),
            userNameSpan: document.getElementById('user-name'),
            logoutButton: document.getElementById('logout-button'),
            reportsContainer: document.getElementById('reports-container'),
            requestTableBody: document.getElementById('request-table-body'),
            userDropdown: document.getElementById('user-dropdown'),
            reportTableHead: document.getElementById('report-table-head'),
            reportTableBody: document.getElementById('report-table-body'),
            noReportMessage: document.getElementById('no-report-message'),
            reportStartDate: document.getElementById('report-start-date'), // NOVA REF
            reportEndDate: document.getElementById('report-end-date'), // NOVA REF
            generateReportBtn: document.getElementById('generate-report-btn'),
            downloadPdfBtn: document.getElementById('download-pdf-btn'),
            monthlyBalance: document.getElementById('monthly-balance'),
            reportTitle: document.getElementById('report-title'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            editModal: document.getElementById('edit-modal'),
            editTimeInput: document.getElementById('edit-time-input'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            saveEditBtn: document.getElementById('save-edit-btn'),
            forgot: { modal: document.getElementById('forgot-password-modal'), link: document.getElementById('forgot-password-link'), close: document.getElementById('close-forgot-modal-button'), form: document.getElementById('forgot-password-form'), email: document.getElementById('forgot-email'), msg: document.getElementById('modal-message') },
            occurrenceSection: document.getElementById('occurrence-section'),
            occurrenceDetails: document.getElementById('occurrence-details'),
            saveOccurrenceBtn: document.getElementById('save-occurrence-btn'),
            occurrenceStatus: document.getElementById('occurrence-status'),
            addEntryModal: document.getElementById('add-entry-modal'),
            addEntryDate: document.getElementById('add-entry-date'),
            addEntryMessage: document.getElementById('add-entry-message'),
            addEntryIn1: document.getElementById('add-entry-in-1'),
            addEntryOut1: document.getElementById('add-entry-out-1'),
            cancelAddBtn: document.getElementById('cancel-add-btn'),
            saveAddBtn: document.getElementById('save-add-btn'),
            justifyModal: document.getElementById('justify-modal'),
            justifyDate: document.getElementById('justify-date'),
            justifyReason: document.getElementById('justify-reason'),
            justifyHours: document.getElementById('justify-hours'),
            justifyMessage: document.getElementById('justify-message'),
            cancelJustifyBtn: document.getElementById('cancel-justify-btn'),
            saveJustifyBtn: document.getElementById('save-justify-btn'),
            requestActionModal: document.getElementById('request-action-modal'),
            reqModalUserName: document.getElementById('req-modal-user-name'),
            reqModalDate: document.getElementById('req-modal-date'),
            reqModalText: document.getElementById('req-modal-text'),
            reqModalAbono: document.getElementById('req-modal-abono'),
            reqModalMessage: document.getElementById('req-modal-message'),
            cancelReqActionBtn: document.getElementById('cancel-req-action-btn'),
            deleteReqActionBtn: document.getElementById('delete-req-action-btn'),
            declineReqActionBtn: document.getElementById('decline-req-action-btn'),
            approveReqActionBtn: document.getElementById('approve-req-action-btn'),
            usersManagementTableBody: document.getElementById('users-management-table-body'),
            finalReportModal: document.getElementById('final-report-modal'),
            finalReportContent: document.getElementById('final-report-content'),
            closeFinalReportModal: document.getElementById('close-final-report-modal'),
            downloadFinalPdfBtn: document.getElementById('download-final-pdf-btn'),
            requestUserFilter: document.getElementById('request-user-filter'),
            requestStartDateFilter: document.getElementById('request-start-date-filter'),
            requestEndDateFilter: document.getElementById('request-end-date-filter'),
            requestSearchFilter: document.getElementById('request-search-filter'),
            userSearchFilter: document.getElementById('user-search-filter'),
            userStatusFilter: document.getElementById('user-status-filter'),
            quickEntryStartDate: document.getElementById('quick-entry-start-date'),
            quickEntryEndDate: document.getElementById('quick-entry-end-date'),
            quickEntryType: document.getElementById('quick-entry-type'),
            applyQuickEntryBtn: document.getElementById('apply-quick-entry-btn'),
            quickEntryStatus: document.getElementById('quick-entry-status'),
            // Abas
            tabReports: document.getElementById('tab-reports'),
            tabRequests: document.getElementById('tab-requests'),
            tabUsers: document.getElementById('tab-users'),
            panelReports: document.getElementById('tab-panel-reports'),
            panelRequests: document.getElementById('tab-panel-requests'),
            panelUsers: document.getElementById('tab-panel-users'),
            // Notificação
            notificationIcon: document.getElementById('requests-notification-icon'),
            notificationBadge: document.getElementById('requests-notification-badge'),
            notificationPopover: document.getElementById('requests-notification-popover'),
            notificationList: document.getElementById('requests-notification-list'),
        };

        let unsubscribe = { users: null, requests: null, entries: null };
        let allUsers = [];
        let allRequests = [];
        let filteredEmployees = [];
        let recordToEdit = null;
        let recordToDelete = null;
        let requestToDelete = null;
        let entryToAddOrEdit = null;
        let dayToJustify = null;
        let userToFinalize = null;
        let requestToAction = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role) {
                    const userRole = userDoc.data().role;
                    const userTeam = userDoc.data().team;
                    if (userRole === 'general_manager' || userRole === 'nupap_manager' || userRole === 'nudof_manager') {
                        ui.loginScreen.classList.add('hidden');
                        ui.appScreen.classList.remove('hidden');
                        ui.userNameSpan.textContent = userDoc.data().name;
                        listenToFirebase(userRole, userTeam);
                    } else {
                        ui.loginError.textContent = "Acesso negado. Apenas gerentes podem acessar esta página.";
                        signOut(auth);
                    }
                } else {
                    ui.loginError.textContent = "Perfil de usuário não encontrado ou incompleto.";
                    signOut(auth);
                }
            } else {
                ui.loginScreen.classList.remove('hidden');
                ui.appScreen.classList.add('hidden');
                if (unsubscribe.users) unsubscribe.users();
                if (unsubscribe.requests) unsubscribe.requests();
                if (unsubscribe.entries) unsubscribe.entries();
            }
        });

        function listenToFirebase(role, team) {
            if (unsubscribe.users) unsubscribe.users();
            const usersRef = collection(db, 'users');
            unsubscribe.users = onSnapshot(usersRef, (usersSnapshot) => {
                allUsers = usersSnapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                filteredEmployees = allUsers.filter(u => u.role === 'employee' && (role === 'general_manager' || (role === 'nupap_manager' && u.team === 'nupap') || (role === 'nudof_manager' && u.team === 'nudof')));

                renderUserDropdown(filteredEmployees.filter(u => (u.status || 'active') === 'active'));
                filterAndRenderUsersManagementTable();
                setupRequestFilters(filteredEmployees);
                
                if (unsubscribe.requests) unsubscribe.requests();
                const requestsRef = collection(db, `/artifacts/${appId}/requests`);
                unsubscribe.requests = onSnapshot(query(requestsRef, orderBy("createdAt", "desc")), (requestsSnapshot) => {
                    allRequests = requestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    filterAndRenderRequests();
                    
                    const pendingRequests = allRequests.filter(req => 
                        req.status === 'pending' && 
                        filteredEmployees.some(emp => emp.id === req.userId)
                    );
                    const pendingCount = pendingRequests.length;

                    if (pendingCount > 0) {
                        ui.notificationBadge.textContent = pendingCount;
                        ui.notificationBadge.classList.remove('hidden');
                    } else {
                        ui.notificationBadge.classList.add('hidden');
                    }
                    
                    renderNotificationPopover(pendingRequests);
                });
            });
        }
        
        function renderNotificationPopover(pendingRequests) {
            ui.notificationList.innerHTML = ''; 
            
            pendingRequests.sort((a, b) => {
                const [dayA, monthA, yearA] = a.date.split('/');
                const dateA = new Date(yearA, monthA - 1, dayA); 
                const [dayB, monthB, yearB] = b.date.split('/');
                const dateB = new Date(yearB, monthB - 1, dayB); 
                return dateA - dateB;
            });
            
            if (pendingRequests.length === 0) {
                ui.notificationList.innerHTML = '<li class="p-3 text-sm text-gray-500">Nenhuma solicitação pendente.</li>';
                return;
            }

            pendingRequests.forEach(req => {
                const li = document.createElement('li');
                li.className = 'p-3 text-sm hover:bg-gray-50 cursor-pointer';
                li.innerHTML = `<strong>${req.userName}</strong><span class="text-gray-600 block">Data: ${req.date}</span>`;
                li.dataset.userId = req.userId;
                
                const [day, month, year] = req.date.split('/');
                const isoDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                li.dataset.date = isoDate;
                
                li.addEventListener('click', () => {
                    switchTab(ui.tabRequests, ui.panelRequests); 
                    
                    ui.requestUserFilter.value = req.userId;
                    ui.requestStartDateFilter.value = isoDate;
                    ui.requestEndDateFilter.value = isoDate;
                    
                    filterAndRenderRequests(); 
                    
                    ui.notificationPopover.classList.add('hidden'); 
                });
                ui.notificationList.appendChild(li);
            });
        }


        function renderUserDropdown(users) {
            ui.userDropdown.innerHTML = '<option value="">Selecione um funcionário</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                ui.userDropdown.appendChild(option);
            });
        }
        
        // --- NOVA LÓGICA DE GERAÇÃO DE RELATÓRIO ---
        ui.generateReportBtn.addEventListener('click', async () => {
            const selectedUserId = ui.userDropdown.value;
            const startDateVal = ui.reportStartDate.value;
            const endDateVal = ui.reportEndDate.value;

            // Importante: Cancelar o listener do 'editável' para não sobrescrever o relatório estático
            if (unsubscribe.entries) {
                unsubscribe.entries();
                unsubscribe.entries = null;
            }

            if (selectedUserId && startDateVal && endDateVal) {
                if(startDateVal > endDateVal) {
                    alert('A data final deve ser posterior à data inicial.');
                    return;
                }
                const startDate = new Date(startDateVal + 'T00:00:00');
                const endDate = new Date(endDateVal + 'T23:59:59');
                await generateAndRenderReport(selectedUserId, startDate, endDate);
            } else {
                ui.reportTitle.textContent = 'Histórico de Registros';
                ui.reportTableBody.innerHTML = '';
                ui.reportTableHead.innerHTML = '';
                ui.monthlyBalance.classList.add('hidden');
                ui.downloadPdfBtn.classList.add('hidden');
                ui.occurrenceSection.classList.add('hidden');
                ui.occurrenceDetails.value = '';
                ui.occurrenceStatus.textContent = '';
                ui.noReportMessage.classList.remove('hidden');
                ui.noReportMessage.textContent = "Por favor, selecione um funcionário e o intervalo de datas.";
            }
        });

        async function generateAndRenderReport(userId, startDate, endDate) {
            ui.reportTitle.textContent = `Carregando dados...`;
            ui.reportTableBody.innerHTML = '';
            ui.monthlyBalance.classList.add('hidden');
            ui.downloadPdfBtn.classList.add('hidden');
            ui.noReportMessage.classList.add('hidden');

            const entriesRef = collection(db, 'artifacts', appId, 'users', userId, 'time_entries');
            
            // Tentativa de busca otimizada (requer índice) ou fallback para busca total
            try {
                // Tenta busca com filtro composto
                const entriesQuery = query(entriesRef, 
                    where("timestamp", ">=", Timestamp.fromDate(startDate)),
                    where("timestamp", "<=", Timestamp.fromDate(endDate)),
                    orderBy("timestamp", "asc")
                );
                const entriesSnapshot = await getDocs(entriesQuery);
                const filteredEntries = entriesSnapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                await renderReportTable(filteredEntries, userId, startDate, endDate);
            } catch(e) {
                console.log("Índice não encontrado ou erro na query composta. Usando fallback de ordenação simples.", e);
                // Fallback: Busca tudo ordenado e filtra no cliente (garante funcionamento sem índice composto)
                try {
                    const qAll = query(entriesRef, orderBy("timestamp", "asc"));
                    const snapAll = await getDocs(qAll);
                    const all = snapAll.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    
                    // Filtra em memória para garantir precisão
                    const filtered = all.filter(e => {
                        if (!e.timestamp) return false;
                        const d = e.timestamp.toDate();
                        return d >= startDate && d <= endDate;
                    });
                    await renderReportTable(filtered, userId, startDate, endDate);
                } catch (err2) {
                     console.error("Erro fatal ao buscar dados:", err2);
                     ui.reportTitle.textContent = `Erro ao carregar dados.`;
                }
            }
        }

        async function renderReportTable(entries, userId, startDate, endDate) {
            const userName = allUsers.find(u => u.id === userId)?.name;
            const startStr = startDate.toLocaleDateString('pt-BR');
            const endStr = endDate.toLocaleDateString('pt-BR');
            const today = new Date();
            
            ui.reportTitle.textContent = `Relatório para ${userName} (${startStr} a ${endStr})`;
            ui.reportTableBody.innerHTML = '';
            ui.reportTableHead.innerHTML = `<tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dia da Semana</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entradas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saídas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saldo do Dia</th></tr>`;
            ui.noReportMessage.classList.add('hidden');
            
            // Busca justificativas
            const requestsRef = collection(db, `/artifacts/${appId}/requests`);
            const q = query(requestsRef, where("userId", "==", userId), where("status", "==", "approved"));
            let approvedRequests = {};
            try {
                const requestsSnapshot = await getDocs(q);
                requestsSnapshot.docs.forEach(doc => {
                    const req = doc.data();
                    if (req.date) {
                        approvedRequests[req.date] = req; 
                    }
                });
            } catch(e) {
                console.error("Erro ao buscar justificativas", e);
            }

            // Organiza entradas por dia (DD/MM/YYYY)
            const entriesByDay = entries.reduce((acc, entry) => {
                try {
                    if (entry.timestamp) {
                        const date = entry.timestamp.toDate().toLocaleDateString('pt-BR');
                        if (!acc[date]) acc[date] = [];
                        acc[date].push(entry);
                    }
                } catch(e) { console.error("Erro ao processar entrada:", entry); }
                return acc;
            }, {});

            let totalBalanceMs = 0;
            const requiredWorkMs = 6 * 3600 * 1000;

            // --- LÓGICA DE LOOP CORRIGIDA ---
            // Usa cópias para não afetar as variáveis originais
            let currentDateItr = new Date(startDate);
            currentDateItr.setHours(0,0,0,0);
            
            const loopEndItr = new Date(endDate);
            loopEndItr.setHours(23,59,59,999);

            // Loop while seguro
            let safetyCounter = 0;
            while(currentDateItr <= loopEndItr && safetyCounter < 370) { // Limite de segurança aprox 1 ano
                safetyCounter++;
                
                try {
                    const dateString = currentDateItr.toLocaleDateString('pt-BR');
                    const dayOfWeek = currentDateItr.toLocaleDateString('pt-BR', { weekday: 'short' });
                    const dayIndex = currentDateItr.getDay();
                    const isWeekend = dayIndex === 0 || dayIndex === 6;
                    // Comparação de dia futuro segura
                    const isFutureDay = currentDateItr > today && currentDateItr.setHours(0,0,0,0) > today.setHours(0,0,0,0);
                    
                    const dayEntries = entriesByDay[dateString] || [];
                    const ins = dayEntries.length > 0 ? dayEntries.filter(e => e.type === 'in').map(e => e.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })).sort().join(', ') : '---';
                    const outs = dayEntries.length > 0 ? dayEntries.filter(e => e.type === 'out').map(e => e.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })).sort().join(', ') : '---';

                    let dailyBalanceText = '---', dailyBalanceClass = 'text-gray-700';

                    if (isWeekend) {
                        dailyBalanceText = 'Fim de Semana';
                        dailyBalanceClass = 'text-gray-500 italic';
                    } else if (isFutureDay) {
                        // Keeps the default '---'
                    } else if (dayEntries.length % 2 !== 0) {
                        dailyBalanceText = 'Batida Ímpar';
                        dailyBalanceClass = 'text-orange-500 font-bold';
                    } else {
                        let workedMs = 0;
                        if (dayEntries.length > 0) {
                            const sorted = dayEntries.sort((a,b) => a.timestamp.toMillis() - b.timestamp.toMillis());
                            for (let i = 0; i < sorted.length; i += 2) {
                                if (sorted[i].type === 'in' && sorted[i+1] && sorted[i+1].type === 'out') {
                                    workedMs += sorted[i+1].timestamp.toMillis() - sorted[i].timestamp.toMillis();
                                }
                            }
                        }

                        const justification = approvedRequests[dateString];
                        let creditedMs = 0;
                        let balanceMs = 0;
                        
                        if (justification) {
                            const hasSpecificAbono = justification.abonoMinutes && justification.abonoMinutes > 0;
                            
                            if (hasSpecificAbono) {
                                creditedMs = justification.abonoMinutes * 60 * 1000;
                            } else {
                                creditedMs = Math.max(0, requiredWorkMs - workedMs);
                            }
                            
                            balanceMs = (workedMs + creditedMs) - requiredWorkMs;

                            const displayBalance = Math.abs(balanceMs) <= 59000 ? '00:00' : formatMilliseconds(balanceMs, true);
                            dailyBalanceText = `${justification.text} (${displayBalance})`;
                            dailyBalanceClass = 'text-blue-600';

                        } else if (dayEntries.length === 0) { 
                            dailyBalanceText = 'Falta';
                            dailyBalanceClass = 'text-red-600 font-bold';
                            balanceMs = -requiredWorkMs;
                        } else { 
                            balanceMs = workedMs - requiredWorkMs;
                            const displayBalance = Math.abs(balanceMs) <= 15 * 60 * 1000 ? '00:00' : formatMilliseconds(balanceMs, true);
                            dailyBalanceText = displayBalance;
                            dailyBalanceClass = balanceMs >= 0 ? 'text-green-600' : 'text-red-600';
                        }
                        const toleranceMs = (15 * 60 * 1000) + (59 * 1000); // 15 min + 59 seg
                        
                        // Proteção contra NaN no saldo
                        if (!isNaN(balanceMs) && Math.abs(balanceMs) > toleranceMs) {
                                totalBalanceMs += balanceMs;
                        }
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4">${dateString}</td><td class="px-6 py-4 capitalize">${dayOfWeek.replace('.','')}</td><td class="px-6 py-4">${ins}</td><td class="px-6 py-4">${outs}</td><td class="px-6 py-4 font-medium ${dailyBalanceClass}">${dailyBalanceText}</td>`;
                    ui.reportTableBody.appendChild(row);

                } catch (errRow) {
                    console.error(`Erro ao renderizar linha para data ${currentDateItr}`, errRow);
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4 text-red-500">Erro na data</td><td colspan="4">Dados inválidos</td>`;
                    ui.reportTableBody.appendChild(row);
                }

                // Incrementa o dia de forma segura para o próximo loop
                currentDateItr.setDate(currentDateItr.getDate() + 1);
            }

            ui.monthlyBalance.textContent = `Saldo total do período: ${formatMilliseconds(totalBalanceMs, true)}`;
            ui.monthlyBalance.className = `mt-4 p-4 rounded-md font-bold text-center ${totalBalanceMs >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            ui.monthlyBalance.classList.remove('hidden');
            ui.downloadPdfBtn.classList.remove('hidden');
            ui.occurrenceSection.classList.remove('hidden');
        }
        
        // Listener principal de mudança de funcionário para carregar dados
        ui.userDropdown.addEventListener('change', async (e) => {
            const selectedUserId = e.target.value;
            
            if (ui.requestUserFilter.value !== selectedUserId) {
                ui.requestUserFilter.value = selectedUserId;
                filterAndRenderRequests(); 
            }

            ui.monthlyBalance.classList.add('hidden');
            ui.downloadPdfBtn.classList.add('hidden');
            
            if (selectedUserId) {
                ui.reportTitle.textContent = `Carregando histórico...`;
                ui.noReportMessage.classList.add('hidden');
                
                // Carregar ocorrência do mês da data INICIAL
                const startDateVal = ui.reportStartDate.value;
                if(startDateVal) {
                     const [y, m, d] = startDateVal.split('-');
                     await loadOccurrence(selectedUserId, parseInt(m, 10), parseInt(y, 10));
                     ui.occurrenceSection.classList.remove('hidden');
                }

                // Iniciar listener de histórico editável
                const entriesRef = collection(db, 'artifacts', appId, 'users', selectedUserId, 'time_entries');
                const entriesQuery = query(entriesRef, orderBy("timestamp", "asc"));
                
                if (unsubscribe.entries) unsubscribe.entries();
                unsubscribe.entries = onSnapshot(entriesQuery, (snapshot) => {
                    const allEntries = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    renderEditableDailyHistory(allEntries, selectedUserId);
                });
            } else {
                ui.reportTableBody.innerHTML = '';
                ui.reportTableHead.innerHTML = '';
                ui.reportTitle.textContent = 'Histórico de Registros';
                ui.occurrenceSection.classList.add('hidden');
                ui.occurrenceDetails.value = '';
                ui.occurrenceStatus.textContent = '';
                ui.noReportMessage.classList.remove('hidden');
                ui.noReportMessage.textContent = "Selecione um funcionário.";
            }
        });
        
        // Listener de mudança nas datas para atualizar ocorrência e histórico editável
        [ui.reportStartDate, ui.reportEndDate].forEach(el => {
            el.addEventListener('change', async () => {
                const selectedUserId = ui.userDropdown.value;
                if(selectedUserId && ui.reportStartDate.value) {
                     const [y, m, d] = ui.reportStartDate.value.split('-');
                     await loadOccurrence(selectedUserId, parseInt(m, 10), parseInt(y, 10));
                     
                     // Se tivermos dados em cache (via snapshot), re-renderizamos
                     // Isso é útil apenas se o usuário NÃO clicou em gerar relatório estático ainda
                     if(unsubscribe.entries) {
                        // Não temos acesso direto aos dados do snapshot aqui sem armazenar em variável global,
                        // mas o fluxo normal é o usuário interagir com o dropdown ou gerar relatório.
                        // Para o 'editável', ele se atualiza ao trocar de usuário ou dados mudarem.
                     }
                }
            });
        });

        async function renderEditableDailyHistory(allEntries, userId) {
            // Se o listener foi cancelado (porque geramos um relatório estático), não faz nada
            if (!unsubscribe.entries) return;

            const startDateVal = ui.reportStartDate.value;
            const endDateVal = ui.reportEndDate.value;
            
            if(!startDateVal || !endDateVal) return;
            if(startDateVal > endDateVal) return;

            const userName = allUsers.find(u => u.id === userId)?.name;
            ui.reportTitle.textContent = `Histórico Editável para ${userName}`;
            ui.reportTableBody.innerHTML = '';
            ui.reportTableHead.innerHTML = `<tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dia da Semana</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entradas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saídas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th></tr>`;
            ui.noReportMessage.classList.add('hidden');
            
            const entriesByDay = allEntries.reduce((acc, entry) => {
                if (entry.timestamp) {
                    const date = entry.timestamp.toDate().toLocaleDateString('pt-BR');
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(entry);
                }
                return acc;
            }, {});
            
            const userRequests = allRequests.filter(r => r.userId === userId);

            let currentDate = new Date(startDateVal + 'T00:00:00');
            const loopEnd = new Date(endDateVal + 'T23:59:59');
            const today = new Date();
            today.setHours(0,0,0,0);

            let safety = 0;
            while(currentDate <= loopEnd && safety < 370) {
                safety++;
                // Lógica original de pular dias futuros no EDITÁVEL mantida
                if (currentDate > today) {
                     currentDate.setDate(currentDate.getDate() + 1);
                     continue; 
                }

                const dateString = currentDate.toLocaleDateString('pt-BR');
                const dayOfWeek = currentDate.toLocaleDateString('pt-BR', { weekday: 'short' });
                const dayIndex = currentDate.getDay();
                const isWeekend = dayIndex === 0 || dayIndex === 6;

                const dayEntries = entriesByDay[dateString] || [];
                const ins = dayEntries.filter(e => e.type === 'in').map(e => e.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })).sort().join(', ');
                const outs = dayEntries.filter(e => e.type === 'out').map(e => e.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })).sort().join(', ');

                const row = document.createElement('tr');
                
                const requestForDay = userRequests.find(r => r.date === dateString);
                let actionsHtml = '';

                if (isWeekend) {
                    actionsHtml = '---';
                } else if (requestForDay) {
                    const statusColors = { pending: 'text-yellow-500', approved: 'text-green-500', declined: 'text-red-500' };
                    const iconColor = statusColors[requestForDay.status] || 'text-gray-500';
                    actionsHtml = `<div class="flex gap-2 items-center">
                        <button class="edit-day-btn text-blue-600 hover:text-blue-900" data-date="${currentDate.toISOString()}" data-user-id="${userId}">Editar</button>
                        <button class="view-request-btn ${iconColor} hover:opacity-75 text-xl" title="Analisar Solicitação" data-request-id="${requestForDay.id}">&#9993;</button>
                    </div>`;
                } else {
                    actionsHtml = `<div class="flex gap-2"><button class="edit-day-btn text-blue-600 hover:text-blue-900" data-date="${currentDate.toISOString()}" data-user-id="${userId}">Editar</button><button class="justify-day-btn text-green-600 hover:text-green-900" data-date="${currentDate.toISOString()}" data-user-id="${userId}">Justificar</button></div>`;
                }

                row.innerHTML = `<td class="px-6 py-4">${dateString}</td><td class="px-6 py-4 capitalize">${dayOfWeek.replace('.','')}</td><td class="px-6 py-4">${ins || '---'}</td><td class="px-6 py-4">${outs || '---'}</td><td class="px-6 py-4">${actionsHtml}</td>`;
                ui.reportTableBody.appendChild(row);

                currentDate.setDate(currentDate.getDate() + 1);
            }

            document.querySelectorAll('.edit-day-btn').forEach(button => button.addEventListener('click', (e) => showAddEntryModal(e.target.dataset.date, e.target.dataset.userId)));
            document.querySelectorAll('.justify-day-btn').forEach(button => button.addEventListener('click', (e) => showJustifyModal(e.target.dataset.date, e.target.dataset.userId)));
            document.querySelectorAll('.view-request-btn').forEach(button => button.addEventListener('click', (e) => {
                const requestId = e.currentTarget.dataset.requestId;
                const requestData = allRequests.find(r => r.id === requestId);
                if (requestData) showRequestActionModal(requestData);
            }));
        }
        
        async function showAddEntryModal(dateStr, userId) {
            const date = new Date(dateStr);
            ui.addEntryDate.textContent = `Editando batidas para: ${date.toLocaleDateString('pt-BR')}`;
            entryToAddOrEdit = { userId, date };

            ui.addEntryIn1.value = '';
            ui.addEntryOut1.value = '';
            ui.addEntryMessage.textContent = ''; 

            const entriesRef = collection(db, 'artifacts', appId, 'users', userId, 'time_entries');
            const startOfDay = new Date(date); startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(date); endOfDay.setHours(23, 59, 59, 999);
            const q = query(entriesRef, where("timestamp", ">=", Timestamp.fromDate(startOfDay)), where("timestamp", "<=", Timestamp.fromDate(endOfDay)));
            
            try {
                const entriesSnapshot = await getDocs(q);
                const dayEntries = entriesSnapshot.docs.map(doc => doc.data()).sort((a, b) => a.timestamp.toMillis() - b.timestamp.toMillis());
                const ins = dayEntries.filter(e => e.type === 'in');
                const outs = dayEntries.filter(e => e.type === 'out');
                const formatTime = (ts) => ts.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                if (ins[0]) ui.addEntryIn1.value = formatTime(ins[0].timestamp);
                if (outs[0]) ui.addEntryOut1.value = formatTime(outs[0].timestamp);
            } catch (error) {
                console.error("Erro ao buscar batidas do dia:", error);
                ui.addEntryMessage.textContent = "Não foi possível carregar as batidas.";
                ui.addEntryMessage.className = 'text-sm mt-4 text-center text-red-600';
            }
            
            ui.addEntryModal.style.display = 'flex';
        }

        function showJustifyModal(dateStr, userId) {
            const date = new Date(dateStr);
            ui.justifyDate.textContent = `Justificativa para: ${date.toLocaleDateString('pt-BR')}`;
            dayToJustify = { userId, date };
            ui.justifyReason.value = '';
            ui.justifyHours.value = '';
            ui.justifyMessage.textContent = '';
            ui.justifyModal.style.display = 'flex';
        }

        function showRequestActionModal(request) {
            requestToAction = request;
            ui.reqModalUserName.textContent = request.userName;
            ui.reqModalDate.textContent = request.date;
            ui.reqModalText.textContent = request.text;
            ui.reqModalMessage.textContent = '';

            if (request.abonoMinutes) {
                const hours = Math.floor(request.abonoMinutes / 60);
                const minutes = request.abonoMinutes % 60;
                ui.reqModalAbono.value = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            } else {
                ui.reqModalAbono.value = '';
            }

            ui.requestActionModal.style.display = 'flex';
        }

        async function saveJustification() {
            if (!dayToJustify) return;
            const { userId, date } = dayToJustify;
            const reason = ui.justifyReason.value.trim();
            const abonoTime = ui.justifyHours.value;

            if (!reason) {
                ui.justifyMessage.textContent = 'O motivo é obrigatório.';
                ui.justifyMessage.className = 'text-sm mt-4 text-center text-red-600';
                return;
            }

            let abonoMinutes = 0;
            if (abonoTime) {
                const [hours, minutes] = abonoTime.split(':').map(Number);
                if (!isNaN(hours) && !isNaN(minutes)) {
                    abonoMinutes = hours * 60 + minutes;
                }
            }

            const msgEl = ui.justifyMessage;
            msgEl.textContent = 'Salvando...';
            msgEl.className = 'text-sm mt-4 text-center text-gray-600';
            ui.saveJustifyBtn.disabled = true; ui.cancelJustifyBtn.disabled = true;
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                msgEl.textContent = 'Usuário não encontrado.';
                msgEl.className = 'text-sm mt-4 text-center text-red-600';
                ui.saveJustifyBtn.disabled = false; ui.cancelJustifyBtn.disabled = false;
                return;
            }

            const newRequest = { 
                userId: userId, 
                userName: user.name, 
                date: date.toLocaleDateString('pt-BR'), 
                text: reason, 
                status: 'approved', 
                createdAt: Timestamp.now(),
                abonoMinutes: abonoMinutes > 0 ? abonoMinutes : null
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/requests`), newRequest);
                msgEl.textContent = "Justificativa salva com sucesso!";
                msgEl.className = 'text-sm mt-4 text-center text-green-600';
                setTimeout(() => {
                    ui.justifyModal.style.display = 'none'; dayToJustify = null; msgEl.textContent = '';
                    ui.saveJustifyBtn.disabled = false; ui.cancelJustifyBtn.disabled = false;
                    ui.generateReportBtn.click();
                }, 1500);
            } catch (error) {
                console.error("Erro ao salvar justificativa:", error);
                msgEl.textContent = "Erro ao salvar a justificativa.";
                msgEl.className = 'text-sm mt-4 text-center text-red-600';
                ui.saveJustifyBtn.disabled = false; ui.cancelJustifyBtn.disabled = false;
            }
        }

        async function saveDayEntries() {
            if (!entryToAddOrEdit) return;
            const { userId, date } = entryToAddOrEdit;
            const msgEl = ui.addEntryMessage;
            msgEl.textContent = 'Salvando...';
            msgEl.className = 'text-sm mt-4 text-center text-gray-600';
            ui.saveAddBtn.disabled = true; ui.cancelAddBtn.disabled = true;
            const times = [{ time: ui.addEntryIn1.value, type: 'in' }, { time: ui.addEntryOut1.value, type: 'out' }];
            const newEntries = [];
            for (const entry of times) {
                if (entry.time) {
                    const [hours, minutes] = entry.time.split(':').map(Number);
                    if (isNaN(hours) || isNaN(minutes)) continue;
                    const newDate = new Date(date);
                    newDate.setHours(hours, minutes, 0, 0);
                    newEntries.push({ timestamp: Timestamp.fromDate(newDate), type: entry.type, source: 'admin_edit' });
                }
            }
            try {
                const entriesRef = collection(db, `artifacts/${appId}/users/${userId}/time_entries`);
                const startOfDay = new Date(date); startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(date); endOfDay.setHours(23, 59, 59, 999);
                const q = query(entriesRef, where("timestamp", ">=", Timestamp.fromDate(startOfDay)), where("timestamp", "<=", Timestamp.fromDate(endOfDay)));
                const entriesToDeleteSnapshot = await getDocs(q);
                const deletePromises = entriesToDeleteSnapshot.docs.map(docSnap => deleteDoc(docSnap.ref));
                await Promise.all(deletePromises);
                const addPromises = newEntries.map(entryData => addDoc(entriesRef, entryData));
                await Promise.all(addPromises);
                msgEl.textContent = "Batidas salvas com sucesso!";
                msgEl.className = 'text-sm mt-4 text-center text-green-600';
                setTimeout(() => {
                    ui.addEntryModal.style.display = 'none'; entryToAddOrEdit = null; msgEl.textContent = '';
                    ui.saveAddBtn.disabled = false; ui.cancelAddBtn.disabled = false;
                }, 1500);
            } catch (error) {
                console.error("Erro ao salvar batidas:", error);
                msgEl.textContent = "Erro ao salvar.";
                msgEl.className = 'text-sm mt-4 text-center text-red-600';
                ui.saveAddBtn.disabled = false; ui.cancelAddBtn.disabled = false;
            }
        }
        
        ui.saveAddBtn.addEventListener('click', saveDayEntries);
        ui.cancelAddBtn.addEventListener('click', () => { ui.addEntryModal.style.display = 'none'; entryToAddOrEdit = null; });

        ui.confirmDeleteBtn.addEventListener('click', async () => {
            if (recordToDelete) {
                try { await deleteDoc(doc(db, `artifacts/${appId}/users/${recordToDelete.userId}/time_entries`, recordToDelete.recordId)); } catch (error) { console.error("Erro ao apagar registro:", error); }
            } else if (requestToDelete) {
                try { await deleteDoc(doc(db, `/artifacts/${appId}/requests`, requestToDelete)); } catch (error) { console.error("Erro ao apagar solicitação:", error); }
            } else if (userToFinalize) {
                await finalizeUserActivity(userToFinalize);
            }
            recordToDelete = null; requestToDelete = null; userToFinalize = null;
            ui.deleteConfirmModal.style.display = 'none';
            document.getElementById('confirm-delete-btn').textContent = 'Apagar';
            document.getElementById('confirm-delete-btn').className = 'py-2 px-4 rounded-md text-white bg-red-600 hover:bg-red-700';
        });

        ui.cancelDeleteBtn.addEventListener('click', () => {
            recordToDelete = null; requestToDelete = null; userToFinalize = null;
            ui.deleteConfirmModal.style.display = 'none';
            document.getElementById('confirm-delete-btn').textContent = 'Apagar';
            document.getElementById('confirm-delete-btn').className = 'py-2 px-4 rounded-md text-white bg-red-600 hover:bg-red-700';
        });

        ui.saveEditBtn.addEventListener('click', async () => {
            if (recordToEdit) {
                const { userId, recordId, date } = recordToEdit;
                const [newHours, newMinutes] = ui.editTimeInput.value.split(':').map(Number);
                const newDate = new Date(date); newDate.setHours(newHours, newMinutes, 0);
                try { await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/time_entries`, recordId), { timestamp: Timestamp.fromDate(newDate) }); } catch (error) { console.error("Erro ao editar registro:", error); } 
                finally { recordToEdit = null; ui.editModal.style.display = 'none'; }
            }
        });

        ui.cancelEditBtn.addEventListener('click', () => { recordToEdit = null; ui.editModal.style.display = 'none'; });

        function setupRequestFilters(users) {
            ui.requestUserFilter.innerHTML = '<option value="">Todos os Funcionários</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                ui.requestUserFilter.appendChild(option);
            });
            ui.requestUserFilter.innerHTML += '<option value="none">Nenhum</option>';
            ui.requestUserFilter.value = 'none';


            [ui.requestUserFilter, ui.requestStartDateFilter, ui.requestEndDateFilter, ui.requestSearchFilter].forEach(el => {
                el.addEventListener('change', filterAndRenderRequests);
                if (el.type === 'text' || el.type === 'date') el.addEventListener('keyup', filterAndRenderRequests);
            });
        }

        function filterAndRenderRequests() {
            const selectedUserId = ui.requestUserFilter.value;
            
            if (ui.userDropdown.value !== selectedUserId) {
                ui.userDropdown.value = selectedUserId;
            }

            const startDate = ui.requestStartDateFilter.value ? new Date(ui.requestStartDateFilter.value + 'T00:00:00') : null;
            const endDate = ui.requestEndDateFilter.value ? new Date(ui.requestEndDateFilter.value + 'T23:59:59') : null;
            const searchText = ui.requestSearchFilter.value.toLowerCase();

            let filteredRequests = allRequests;

            if (selectedUserId === 'none') {
                filteredRequests = [];
            } else if (selectedUserId) {
                filteredRequests = filteredRequests.filter(req => req.userId === selectedUserId);
            }
            
            if (startDate) {
                filteredRequests = filteredRequests.filter(req => {
                    const [day, month, year] = req.date.split('/');
                    const reqDate = new Date(year, month - 1, day);
                    return reqDate >= startDate;
                });
            }
            if (endDate) {
                filteredRequests = filteredRequests.filter(req => {
                    const [day, month, year] = req.date.split('/');
                    const reqDate = new Date(year, month - 1, day);
                    return reqDate <= endDate;
                });
            }
            
            if (searchText) {
                filteredRequests = filteredRequests.filter(req => req.text.toLowerCase().includes(searchText));
            }

            filteredRequests.sort((a, b) => {
                const [dayA, monthA, yearA] = a.date.split('/');
                const dateA = new Date(yearA, monthA - 1, dayA);
                const [dayB, monthB, yearB] = b.date.split('/');
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateA - dateB;
            });
            
            renderRequestsTable(filteredRequests);
        }

        function renderRequestsTable(requests) {
            ui.requestTableBody.innerHTML = '';
            
            if (requests.length === 0) {
                 ui.requestTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhuma solicitação encontrada para os filtros aplicados.</td></tr>';
                 return;
            }
            
            requests.forEach(req => {
                const statusClass = req.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : req.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4">${req.userName}</td><td class="px-6 py-4">${req.date}</td>
                    <td class="px-6 py-4 text-xs font-semibold whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${req.status.toUpperCase()}</span></td>
                    <td class="px-6 py-4">${req.text}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${req.status === 'pending' ? `<button class="approve-btn text-green-600 hover:text-green-900 mr-2" data-request-id="${req.id}">Aprovar</button><button class="decline-btn text-red-600 hover:text-red-900 mr-2" data-request-id="${req.id}">Recusar</button>` : ''}
                        <button class="delete-request-btn text-red-600 hover:text-red-900" data-request-id="${req.id}">Apagar</button>
                    </td>`;
                row.querySelector('.approve-btn')?.addEventListener('click', (e) => updateRequestStatus(e.target.dataset.requestId, 'approved'));
                row.querySelector('.decline-btn')?.addEventListener('click', (e) => updateRequestStatus(e.target.dataset.requestId, 'declined'));
                row.querySelector('.delete-request-btn')?.addEventListener('click', (e) => {
                    userToFinalize = null; recordToDelete = null; requestToDelete = e.target.dataset.requestId;
                    document.getElementById('delete-modal-title').textContent = 'Confirmar Exclusão de Solicitação';
                    document.getElementById('delete-modal-text').textContent = 'Tem certeza que deseja apagar esta solicitação? Esta ação não pode ser desfeita.';
                    ui.deleteConfirmModal.style.display = 'flex';
                });
                ui.requestTableBody.appendChild(row);
            });
        }

        async function updateRequestStatus(requestId, status, abonoMinutes = null) {
            const dataToUpdate = { status, abonoMinutes };
            if(abonoMinutes === null) {
                dataToUpdate.abonoMinutes = null;
            }
            await updateDoc(doc(db, `/artifacts/${appId}/requests`, requestId), dataToUpdate);
            ui.generateReportBtn.click();
        }

        function formatMilliseconds(ms, showSign = false) {
            if (isNaN(ms)) return "00:00";
            const isNegative = ms < 0; if (isNegative) ms = -ms;
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const sign = isNegative ? '-' : (showSign ? '+' : '');
            return `${sign}${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }
        
        async function loadOccurrence(userId, month, year) {
            if (!userId || !month || !year) return;
            ui.occurrenceDetails.value = ''; ui.occurrenceStatus.textContent = '';
            try {
                const reportId = `${year}-${String(month).padStart(2, '0')}`;
                const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', reportId);
                const reportDocSnap = await getDoc(reportDocRef);
                if (reportDocSnap.exists()) { ui.occurrenceDetails.value = reportDocSnap.data().occurrenceText || ''; }
            } catch (error) { console.error("Erro ao carregar ocorrência:", error); }
        }

        async function saveOccurrence() {
            const selectedUserId = ui.userDropdown.value; 
            const startDateVal = ui.reportStartDate.value;
            if (!selectedUserId || !startDateVal) {
                ui.occurrenceStatus.textContent = 'Selecione um funcionário e uma data inicial.';
                ui.occurrenceStatus.className = 'text-sm text-red-500 mr-4';
                return;
            }
            // Usa o mês/ano da DATA INICIAL para salvar
            const [year, month] = startDateVal.split('-');
            const reportId = `${year}-${month}`;
            const reportDocRef = doc(db, 'artifacts', appId, 'users', selectedUserId, 'reports', reportId);
            ui.occurrenceStatus.textContent = 'Salvando...';
            ui.occurrenceStatus.className = 'text-sm text-gray-500 mr-4';
            try {
                await setDoc(reportDocRef, { occurrenceText: ui.occurrenceDetails.value }, { merge: true });
                ui.occurrenceStatus.textContent = 'Salvo com sucesso!';
                ui.occurrenceStatus.className = 'text-sm text-green-600 mr-4';
                setTimeout(() => { ui.occurrenceStatus.textContent = ''; }, 3000);
            } catch (error) {
                console.error("Erro ao salvar ocorrência:", error);
                ui.occurrenceStatus.textContent = 'Erro ao salvar.';
                ui.occurrenceStatus.className = 'text-sm text-red-600 mr-4';
            }
        }
        ui.saveOccurrenceBtn.addEventListener('click', saveOccurrence);

        async function generatePdf() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const selectedUserId = ui.userDropdown.value;
            const userName = allUsers.find(u => u.id === selectedUserId)?.name || 'Usuário';
            
            // Formatando período para o título
            const startDate = new Date(ui.reportStartDate.value + 'T00:00:00');
            const endDate = new Date(ui.reportEndDate.value + 'T00:00:00');
            const periodStr = `${startDate.toLocaleDateString('pt-BR')} a ${endDate.toLocaleDateString('pt-BR')}`;

            doc.setFontSize(18); doc.text(`Relatório de Ponto - ${userName}`, 14, 22);
            doc.setFontSize(12); doc.text(`Período: ${periodStr}`, 14, 30);
            const head = [['Data', 'Dia da Semana', 'Entradas', 'Saídas', 'Saldo do Dia']];
            const body = Array.from(ui.reportTableBody.querySelectorAll('tr')).map(row => Array.from(row.querySelectorAll('td')).map(cell => cell.innerText));
            doc.autoTable({ head, body, startY: 40, theme: 'striped', headStyles: { fillColor: [22, 160, 133] } });
            let finalY = doc.lastAutoTable.finalY;
            
            const requestsRef = collection(db, `/artifacts/${appId}/requests`);
            const q = query(requestsRef, where("userId", "==", selectedUserId), where("status", "==", "approved"));
            const requestsSnapshot = await getDocs(q);
            
            // Filtrar requests pelo período
            const rangeRequests = requestsSnapshot.docs.map(d => d.data()).filter(req => {
                if (!req.date) return false;
                const [d, m, y] = req.date.split('/');
                const rDate = new Date(y, m-1, d);
                // Ajustar horas para comparação justa
                rDate.setHours(0,0,0,0);
                const start = new Date(startDate); start.setHours(0,0,0,0);
                const end = new Date(endDate); end.setHours(0,0,0,0);
                return rDate >= start && rDate <= end;
            });

            rangeRequests.sort((a, b) => {
                const [dayA, monthA, yearA] = a.date.split('/');
                const dateA = new Date(yearA, monthA - 1, dayA);
                const [dayB, monthB, yearB] = b.date.split('/');
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateA - dateB;
            });

            if (rangeRequests.length > 0) {
                doc.setFontSize(14); doc.text('Solicitações Autorizadas', 14, finalY + 15);
                doc.autoTable({ head: [['Data', 'Motivo']], body: rangeRequests.map(req => [req.date, req.text]), startY: finalY + 18, theme: 'grid', headStyles: { fillColor: [44, 62, 80] } });
                finalY = doc.lastAutoTable.finalY;
            }
            doc.setFontSize(12); doc.setFont('helvetica', 'bold'); doc.text(ui.monthlyBalance.textContent, 14, finalY + 10);
            const occurrenceText = ui.occurrenceDetails.value;
            doc.setFontSize(12); doc.setFont('helvetica', 'bold'); doc.text('Registro de Ocorrências:', 14, finalY + 25);
            doc.setLineWidth(0.2); doc.setDrawColor(100); doc.rect(14, finalY + 28, 182, 30);
            if (occurrenceText && occurrenceText.trim() !== '') {
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(doc.splitTextToSize(occurrenceText, 178), 16, finalY + 33);
            }
            doc.save(`relatorio_${userName.replace(/\s+/g, '_').toLowerCase()}.pdf`);
        }

        function filterAndRenderUsersManagementTable() {
            const searchTerm = ui.userSearchFilter.value.toLowerCase();
            const status = ui.userStatusFilter.value;
            let usersToRender = filteredEmployees;

            if (searchTerm) {
                usersToRender = usersToRender.filter(user => user.name.toLowerCase().includes(searchTerm));
            }
            if (status !== 'all') {
                usersToRender = usersToRender.filter(user => (user.status || 'active') === status);
            }
            renderUsersManagementTable(usersToRender);
        }

        function renderUsersManagementTable(users) {
            ui.usersManagementTableBody.innerHTML = '';
            users.forEach(user => {
                const userStatus = user.status || 'active';
                const statusClass = userStatus === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                let actionButtonsHtml = userStatus === 'active' 
                    ? `<button class="finalize-activity-btn font-medium text-red-600 hover:text-red-900" data-user-id="${user.id}">Encerrar Atividades</button>`
                    : `<button class="toggle-status-btn font-medium text-green-600 hover:text-green-900" data-user-id="${user.id}" data-status="inactive">Reativar</button>`;
                const row = document.createElement('tr');
                row.innerHTML = `<td class="px-6 py-4">${user.name}</td><td class="px-6 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${userStatus.toUpperCase()}</span></td><td class="px-6 py-4 flex flex-wrap gap-4">${actionButtonsHtml}<button class="final-report-btn font-medium text-blue-600 hover:text-blue-900" data-user-id="${user.id}">Relatório Final</button></td>`;
                ui.usersManagementTableBody.appendChild(row);
            });
            document.querySelectorAll('.toggle-status-btn, .finalize-activity-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userId = e.target.dataset.userId;
                    if (e.target.classList.contains('finalize-activity-btn')) {
                        const userName = allUsers.find(u => u.id === userId)?.name || 'este usuário';
                        userToFinalize = userId; recordToDelete = null; requestToDelete = null;
                        document.getElementById('delete-modal-title').textContent = 'Confirmar Encerramento';
                        document.getElementById('delete-modal-text').textContent = `Deseja encerrar as atividades de ${userName}? O relatório final será baixado e o usuário desativado.`;
                        document.getElementById('confirm-delete-btn').textContent = 'Encerrar';
                        document.getElementById('confirm-delete-btn').className = 'py-2 px-4 rounded-md text-white bg-red-600 hover:bg-red-700';
                        ui.deleteConfirmModal.style.display = 'flex';
                    } else { toggleUserStatus(userId, e.target.dataset.status); }
                });
            });
            document.querySelectorAll('.final-report-btn').forEach(button => button.addEventListener('click', (e) => generateFinalReport(e.target.dataset.userId)));
        }

        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            try { await updateDoc(doc(db, 'users', userId), { status: newStatus }); } catch (error) { console.error("Error updating user status:", error); }
        }
        
        async function calculateFinalReportData(userId, isFinalizing = false) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return null;

            const entriesRef = collection(db, 'artifacts', appId, 'users', userId, 'time_entries');
            const entriesSnapshot = await getDocs(query(entriesRef, orderBy("timestamp", "asc")));
            const allEntries = entriesSnapshot.docs.map(doc => doc.data());

            if (allEntries.length === 0) {
                return { isDataAvailable: false, userName: user.name, detailedBody: [], approvedRequests: [] };
            }

            const firstEntryDate = allEntries[0].timestamp.toDate();
            const lastEntryDate = isFinalizing ? new Date() : allEntries[allEntries.length - 1].timestamp.toDate();
            const contractPeriod = `${firstEntryDate.toLocaleDateString('pt-BR')} a ${lastEntryDate.toLocaleDateString('pt-BR')}`;
            let totalBalanceMs = 0, absenceDays = 0, totalWorkedMs = 0;
            const detailedBody = [];

            const entriesByDay = allEntries.reduce((acc, entry) => {
                const date = entry.timestamp.toDate().toLocaleDateString('pt-BR');
                if (!acc[date]) acc[date] = []; acc[date].push(entry);
                return acc;
            }, {});

            const requestsRef = collection(db, `/artifacts/${appId}/requests`);
            const q = query(requestsRef, where("userId", "==", userId), where("status", "==", "approved"));
            const requestsSnapshot = await getDocs(q);
            const approvedRequests = requestsSnapshot.docs.map(doc => doc.data());
            const justifiedDates = new Set(approvedRequests.map(req => req.date));
            let currentDate = new Date(firstEntryDate); currentDate.setHours(0, 0, 0, 0);
            const finalDate = new Date(lastEntryDate); finalDate.setHours(0, 0, 0, 0);

            while (currentDate <= finalDate) {
                const dayIndex = currentDate.getDay();
                const dateString = currentDate.toLocaleDateString('pt-BR');
                const dayOfWeek = currentDate.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
                const isWeekend = dayIndex === 0 || dayIndex === 6;
                let ins = '---', outs = '---', dailyBalanceText = '---';

                if (isWeekend) {
                    dailyBalanceText = 'Fim de Semana';
                } else {
                    const dayEntries = entriesByDay[dateString];
                    const isJustified = justifiedDates.has(dateString);

                    if (dayEntries && dayEntries.length > 0) {
                        const sortedEntries = dayEntries.sort((a, b) => a.timestamp.toMillis() - b.timestamp.toMillis());
                        ins = sortedEntries.filter(e => e.type === 'in').map(e => e.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })).join(', ');
                        outs = sortedEntries.filter(e => e.type === 'out').map(e => e.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })).join(', ');
                    }

                    if (isJustified) {
                        const req = approvedRequests.find(r => r.date === dateString);
                        dailyBalanceText = req ? req.text : 'Justificado';
                    } else if (!dayEntries) {
                        totalBalanceMs -= (6 * 3600 * 1000);
                        absenceDays++;
                        dailyBalanceText = 'Falta';
                    } else if (dayEntries.length % 2 === 0) {
                        let dailyWorkedMs = 0;
                        const sortedEntries = dayEntries.sort((a, b) => a.timestamp.toMillis() - b.timestamp.toMillis());
                        for (let i = 0; i < sortedEntries.length; i += 2) {
                            if (sortedEntries[i].type === 'in' && sortedEntries[i + 1] && sortedEntries[i + 1].type === 'out') {
                                dailyWorkedMs += sortedEntries[i + 1].timestamp.toMillis() - sortedEntries[i].timestamp.toMillis();
                            }
                        }
                        totalWorkedMs += dailyWorkedMs;
                        const dailyBalanceMs = dailyWorkedMs - (6 * 3600 * 1000);
                        const toleranceMs = (15 * 60 * 1000) + (59 * 1000); // 15 min + 59 seg
                        
                        if (Math.abs(dailyBalanceMs) > toleranceMs) {
                            totalBalanceMs += dailyBalanceMs;
                        }
                        dailyBalanceText = Math.abs(dailyBalanceMs) <= toleranceMs ? '00:00' : formatMilliseconds(dailyBalanceMs, true);
                    } else {
                        dailyBalanceText = 'Batida Ímpar';
                    }
                }
                detailedBody.push([dateString, dayOfWeek, ins, outs, dailyBalanceText]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return { isDataAvailable: true, userName: user.name, contractPeriod, totalWorked: formatMilliseconds(totalWorkedMs), absenceDays, finalBalance: formatMilliseconds(totalBalanceMs, true), detailedBody, approvedRequests };
        }

        async function generateFinalReport(userId) {
            ui.finalReportContent.innerHTML = `<div class="loader mx-auto"></div><p class="text-center mt-2">Calculando relatório...</p>`;
            ui.finalReportModal.style.display = 'flex';
            const reportData = await calculateFinalReportData(userId, false);
            if (!reportData || !reportData.isDataAvailable) {
                 ui.finalReportContent.innerHTML = `<p><strong>Funcionário:</strong> ${reportData.userName}</p><p>Nenhum registro de ponto encontrado.</p>`;
                 ui.downloadFinalPdfBtn.classList.add('hidden');
                 return;
            }
            ui.finalReportContent.innerHTML = `<p><strong>Funcionário:</strong> ${reportData.userName}</p><p><strong>Período:</strong> ${reportData.contractPeriod}</p><p><strong>Total de Horas Trabalhadas (Bruto):</strong> ${reportData.totalWorked}</p><p><strong>Dias de Falta (não justificados):</strong> ${reportData.absenceDays}</p><p class="text-lg font-bold mt-2"><strong>Saldo Final de Horas:</strong> ${reportData.finalBalance}</p>`;
            ui.downloadFinalPdfBtn.classList.remove('hidden');
            const newDownloadBtn = ui.downloadFinalPdfBtn.cloneNode(true);
            ui.downloadFinalPdfBtn.parentNode.replaceChild(newDownloadBtn, ui.downloadFinalPdfBtn);
            ui.downloadFinalPdfBtn = newDownloadBtn;
            ui.downloadFinalPdfBtn.addEventListener('click', () => generateFinalReportPdf(reportData));
        }
        
        async function finalizeUserActivity(userId) {
            try {
                const reportData = await calculateFinalReportData(userId, true);
                if (reportData && reportData.isDataAvailable) { generateFinalReportPdf(reportData); }
                await updateDoc(doc(db, 'users', userId), { status: 'inactive' });
            } catch (error) { console.error("Erro ao encerrar atividades:", error); }
        }

        function generateFinalReportPdf(reportData) {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFontSize(18); doc.text(`Relatório Final de Horas - ${reportData.userName}`, 14, 22);
            doc.setFontSize(12); doc.text(`Período do Contrato: ${reportData.contractPeriod}`, 14, 30);
            
            let finalY = 40;
            doc.setFont('helvetica', 'normal');
            doc.text(`Total de Horas Trabalhadas (Bruto): ${reportData.totalWorked}`, 14, finalY);
            doc.text(`Dias de Falta (não justificados): ${reportData.absenceDays}`, 14, finalY + 8);
            doc.setFontSize(14); doc.setFont('helvetica', 'bold');
            doc.text(`Saldo Final de Horas: ${reportData.finalBalance}`, 14, finalY + 18);
            finalY = finalY + 30;

            if (reportData.approvedRequests && reportData.approvedRequests.length > 0) {
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Solicitações Autorizadas', 14, finalY);
                
                reportData.approvedRequests.sort((a, b) => {
                    const [dayA, monthA, yearA] = a.date.split('/');
                    const dateA = new Date(yearA, monthA - 1, dayA);
                    const [dayB, monthB, yearB] = b.date.split('/');
                    const dateB = new Date(yearB, monthB - 1, dayB);
                    return dateA - dateB;
                });

                const requestsHead = [['Data', 'Motivo']];
                const requestsBody = reportData.approvedRequests.map(req => [req.date, req.text]);

                doc.autoTable({
                    head: requestsHead,
                    body: requestsBody,
                    startY: finalY + 5,
                    theme: 'grid',
                    headStyles: { fillColor: [44, 62, 80] },
                });
                finalY = doc.lastAutoTable.finalY + 10;
            }

            doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            doc.text('Registros de Ponto Detalhados', 14, finalY);
            
            const head = [['Data', 'Dia', 'Entradas', 'Saídas', 'Saldo']];
            doc.autoTable({ 
                head, 
                body: reportData.detailedBody, 
                startY: finalY + 5,
                theme: 'striped', 
                headStyles: { fillColor: [22, 160, 133] } 
            });
            
            doc.save(`relatorio_final_${reportData.userName.replace(/\s+/g, '_').toLowerCase()}.pdf`);
        }

        ui.downloadPdfBtn.addEventListener('click', generatePdf);
        ui.loginForm.addEventListener('submit', async (e) => { e.preventDefault(); ui.loginError.textContent = ''; try { await signInWithEmailAndPassword(auth, ui.loginForm.email.value, ui.loginForm.password.value); } catch (error) { ui.loginError.textContent = "E-mail ou senha inválidos."; } });
        ui.logoutButton.addEventListener('click', () => signOut(auth));
        
        ui.forgot.link.addEventListener('click', (e) => { e.preventDefault(); ui.forgot.modal.style.display = 'flex'; });
        ui.forgot.close.addEventListener('click', () => { ui.forgot.modal.style.display = 'none'; ui.forgot.msg.textContent = ''; });
        ui.forgot.form.addEventListener('submit', async (e) => {
            e.preventDefault(); ui.forgot.msg.textContent = 'Enviando...';
            try {
                await sendPasswordResetEmail(auth, ui.forgot.email.value);
                ui.forgot.msg.textContent = 'Link de redefinição enviado!'; ui.forgot.msg.className = 'text-sm mt-4 text-center text-green-600';
            } catch (error) {
                ui.forgot.msg.textContent = 'Erro ao enviar. Verifique o e-mail.'; ui.forgot.msg.className = 'text-sm mt-4 text-center text-red-600';
            }
        });
        
        ui.saveJustifyBtn.addEventListener('click', saveJustification);
        ui.cancelJustifyBtn.addEventListener('click', () => { ui.justifyModal.style.display = 'none'; dayToJustify = null; });
        
        ui.approveReqActionBtn.addEventListener('click', async () => {
            if (!requestToAction) return;
            const abonoTime = ui.reqModalAbono.value;
            let abonoMinutes = null;
            if (abonoTime) {
                const [hours, minutes] = abonoTime.split(':').map(Number);
                if (!isNaN(hours) && !isNaN(minutes)) {
                    abonoMinutes = hours * 60 + minutes;
                }
            }
            await updateRequestStatus(requestToAction.id, 'approved', abonoMinutes);
            ui.requestActionModal.style.display = 'none';
        });

        ui.declineReqActionBtn.addEventListener('click', async () => {
            if (!requestToAction) return;
            await updateRequestStatus(requestToAction.id, 'declined', null);
            ui.requestActionModal.style.display = 'none';
        });
        
        ui.deleteReqActionBtn.addEventListener('click', () => {
             if (!requestToAction) return;
             requestToDelete = requestToAction.id;
             document.getElementById('delete-modal-title').textContent = 'Confirmar Exclusão de Solicitação';
             document.getElementById('delete-modal-text').textContent = 'Tem certeza que deseja apagar esta solicitação? Esta ação não pode ser desfeita.';
             ui.deleteConfirmModal.style.display = 'flex';
             ui.requestActionModal.style.display = 'none';
        });

        ui.cancelReqActionBtn.addEventListener('click', () => {
            ui.requestActionModal.style.display = 'none';
            requestToAction = null;
        });

        ui.closeFinalReportModal.addEventListener('click', () => { ui.finalReportModal.style.display = 'none'; });
        ui.userSearchFilter.addEventListener('keyup', filterAndRenderUsersManagementTable);
        ui.userStatusFilter.addEventListener('change', filterAndRenderUsersManagementTable);
        ui.applyQuickEntryBtn.addEventListener('click', applyQuickEntry);

        // *** INÍCIO: LÓGICA DAS ABAS ***
        const tabs = [ui.tabReports, ui.tabRequests, ui.tabUsers];
        const panels = [ui.panelReports, ui.panelRequests, ui.panelUsers];

        function switchTab(clickedTab, targetPanel) {
            tabs.forEach(tab => {
                tab.classList.remove('border-green-500', 'text-green-600');
                tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            panels.forEach(panel => panel.classList.add('hidden'));

            clickedTab.classList.add('border-green-500', 'text-green-600');
            clickedTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            targetPanel.classList.remove('hidden');
        }

        ui.tabReports.addEventListener('click', () => switchTab(ui.tabReports, ui.panelReports));
        ui.tabRequests.addEventListener('click', () => switchTab(ui.tabRequests, ui.panelRequests));
        ui.tabUsers.addEventListener('click', () => switchTab(ui.tabUsers, ui.panelUsers));
        
        // Notificação
        ui.notificationIcon.addEventListener('click', (e) => {
            e.stopPropagation(); 
            ui.notificationPopover.classList.toggle('hidden');
        });
        
        document.addEventListener('click', (e) => {
            if (!ui.notificationIcon.contains(e.target) && !ui.notificationPopover.contains(e.target)) {
                ui.notificationPopover.classList.add('hidden');
            }
        });

        async function applyQuickEntry() {
            const userId = ui.userDropdown.value;
            const startDateStr = ui.quickEntryStartDate.value;
            const endDateStr = ui.quickEntryEndDate.value;
            const type = ui.quickEntryType.value;
            const statusEl = ui.quickEntryStatus;

            if (!userId || !startDateStr || !endDateStr) {
                statusEl.textContent = 'Por favor, selecione um funcionário e o período completo.';
                statusEl.className = 'text-sm mt-4 text-center text-red-600';
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');

            if (startDate > endDate) {
                statusEl.textContent = 'A data de início não pode ser posterior à data de fim.';
                statusEl.className = 'text-sm mt-4 text-center text-red-600';
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                statusEl.textContent = 'Funcionário não encontrado.';
                statusEl.className = 'text-sm mt-4 text-center text-red-600';
                return;
            }

            statusEl.textContent = 'Aplicando...';
            statusEl.className = 'text-sm mt-4 text-center text-gray-600';
            ui.applyQuickEntryBtn.disabled = true;

            try {
                const batch = writeBatch(db);
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    const dayIndex = currentDate.getDay();
                    if (dayIndex !== 0 && dayIndex !== 6) { 
                        const newRequest = {
                            userId: userId,
                            userName: user.name,
                            date: currentDate.toLocaleDateString('pt-BR'),
                            text: type,
                            status: 'approved',
                            createdAt: Timestamp.now(),
                            abonoMinutes: 360 
                        };
                        const newReqRef = doc(collection(db, `artifacts/${appId}/requests`));
                        batch.set(newReqRef, newRequest);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                await batch.commit();
                statusEl.textContent = 'Período aplicado com sucesso!';
                statusEl.className = 'text-sm mt-4 text-center text-green-600';
                ui.generateReportBtn.click(); 
            } catch (error) {
                console.error("Erro ao aplicar período:", error);
                statusEl.textContent = 'Erro ao salvar. Tente novamente.';
                statusEl.className = 'text-sm mt-4 text-center text-red-600';
            } finally {
                ui.applyQuickEntryBtn.disabled = false;
                setTimeout(() => { statusEl.textContent = ''; }, 4000);
            }
        }

        document.getElementById('header-date').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        // Define data inicial para o primeiro dia do mês atual e final para hoje, como padrão
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        ui.reportStartDate.value = firstDay.toISOString().split('T')[0];
        ui.reportEndDate.value = now.toISOString().split('T')[0];

    </script>
</body>
</html>
